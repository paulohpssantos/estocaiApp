<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Abrir App</title>
    <style>
        /* overlay/modal simples */
        .overlay {
          position: fixed;
          inset: 0;
          background: rgba(0,0,0,0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
        }
        .modal {
          background: #fff;
          padding: 20px;
          border-radius: 8px;
          text-align: center;
          max-width: 320px;
          width: 90%;
          box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        .modal img {
          max-width: 120px;
          height: auto;
          display: block;
          margin: 0 auto 12px;
        }
        .modal p {
          margin: 0 0 12px;
          font-size: 16px;
          color: #222;
        }
        .btn {
          background: #007bff;
          color: #fff;
          border: none;
          padding: 8px 14px;
          border-radius: 6px;
          cursor: pointer;
          font-size: 14px;
        }
    </style>
</head>
<body>
<p>Abrindo o app...</p>

<!-- modal que mostra a logo e mensagem -->
<div id="successOverlay" class="overlay" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Usuário cadastrado">
        <img src="/img/estocai.png" alt="Estocai logo" />
        <p>Usuário cadastrado com sucesso</p>
        <button id="okBtn" class="btn">OK</button>
    </div>
</div>

<script>
    const params = new URLSearchParams(window.location.search);
    const cpf = params.get('cpf') || '';
    const appUrl = params.get('appUrl') || '';

    const cpfEncoded = encodeURIComponent(cpf);
    const deepLink = 'estocaiapp://termos?cpf=' + cpfEncoded + '&aceito=true';
    const fallbackWeb = encodeURIComponent(appUrl + '/termos?aceito=true');
    const intentUri = 'intent://termos?cpf=' + cpfEncoded + '#Intent;scheme=estocaiapp;package=com.paulohps.EstocaiApp;S.browser_fallback_url=' + fallbackWeb + ';end';

    function isAndroid() { return /Android/i.test(navigator.userAgent); }

    function openAppFlow() {
      if (isAndroid()) {
        window.location = intentUri;
      } else {
        const now = Date.now();
        window.location = deepLink;
        setTimeout(function() {
          // tenta fechar a aba/janela; se falhar, redireciona para web
          try {
            window.open('', '_self');
            window.close();
            // se browser bloqueou close, redireciona para fallback
            setTimeout(function() {
              if (!window.closed) window.location = appUrl + '/termos?aceito=true';
            }, 600);
          } catch (e) {
            window.location = appUrl + '/termos?aceito=true';
          }
        }, 1200);
      }
    }

    // mostra modal com logo e chama openAppFlow ao fechá-lo
    window.addEventListener('load', function() {
      const overlay = document.getElementById('successOverlay');
      const okBtn = document.getElementById('okBtn');

      // mostra o modal
      overlay.style.display = 'flex';

      // fechar ao clicar OK
      okBtn.addEventListener('click', function() {
        overlay.style.display = 'none';
        // pequena espera para evitar race com fechamento de modal
        setTimeout(openAppFlow, 200);
      });

      // fecha automaticamente após 1.2s se o usuário não clicar
      setTimeout(function() {
        if (overlay.style.display !== 'none') {
          overlay.style.display = 'none';
          openAppFlow();
        }
      }, 1200);
    });
</script>
</body>
</html>